<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../elements/package-line.html">

<dom-module name="trip-request">
	<style>
    .table-request {
      width: 100%;
      margin: 10px;
    }
    .comment-text-area {
      width: 99%;
    }
    .package-button {
      float: right;
    }
    .add-package {
      margin: 10px 5% 10px 5%;
      background: #efefef;
    }
    .y-o-span {
      align-self: flex-end;
      margin: 10px;
    }
    .add-package-buttons {
      display: inline-flex!important;
      vertical-align: bottom;
    }
    .header-add-package {
      margin: 9px;
    }
    .request {
      position: relative;
      background: #fff;
      border: 2px solid #ccc;
      border-radius: 3px;
      padding: 20px;
      margin-top: 11px;
    }
    .request:after, .request:before {
      bottom: 100%;
      left: 30px;
      border: solid transparent;
      content: " ";
      height: 0;
      width: 0;
      position: absolute;
      pointer-events: none;
    }

    .request:after {
      border-color: rgba(255, 255, 255, 0);
      border-bottom-color: #fff;
      border-width: 10px;
      margin-left: -10px;
    }
    .request:before {
      border-color: rgba(204, 204, 204, 0);
      border-bottom-color: #ccc;
      border-width: 13px;
      margin-left: -13px;
    }
  </style>
	<template>
		<div class="request layout vertical">
      <table class="table-request">
        <tr> 
          <td>Salida</td> 
          <td>
          	<select value="{{d::input}}">
		        	<template is="dom-repeat" items="[[trip.wps]]">
		        		<option value="[[index]]">[[item.city]]</option>
		        	</template>
		        </select>
          </td>
          <td><span>[[getd(d)]]</span>/<span>[[getm(d)]]</span></td>
          <td><span>[[gett(d)</span></td>
        </tr>
        <tr>
          <td colspan="4"><span>[[geta(d)]]</span></td>
        </tr>
        <tr> 
          <td>Llegada</td> 
          <td>
          	<select value="{{a::input}}">
		        	<template is="dom-repeat" items="[[trip.wps]]">
		        		<option value="[[index]]"><span>[[item.city]]</span> (<span>[[getT(d, index, seat, pkn)]]</span>€)</option>
		        	</template>
		        </select>
          </td>
          <td><span>[[getd(a)]]</span>/<span>[[getm(a)]]</span></td>
          <td><span>[[gett(a)]]</span></td>
        </tr>
        <tr>
          <td colspan="4"><span>[[geta(a)]]</span></td>
        </tr>

        <tr>
          <td>Comentario</td>
        </tr>
        <tr>
          <td colspan="4"><textarea class="comment-text-area" rows="4" name="comment"></textarea></td>
        </tr>
        <tr>
          <td>Asiento</td>
          <td><paper-checkbox checked="{{seat}}"></paper-checkbox></td>
          <td>x<span>[[getc(d,a,seat)]]</span>€</td>
        </tr>
        <tr>
          <td colspan="2">Paquetes</td>
          <!-- <td><input type="Number" min="0" max="10" value="{{pkn::input}}"></td> -->
          <td>x<span>[[getpkc(d,a,pkn)]]</span>€</td>
        </tr>
        <tr>
          <td colspan="4">
            
              <div class="layout vertical add-package">
                <template is="dom-if" if="[[!selectedpackage]]">
                  <div class="layout horizontal header-add-package">
                    <paper-button class="package-button" raised on-click="aaa">Añadir paquete</paper-button>
                    <div class="flex"></div>
                    <div class="layout horizontal center"><paper-button class="package-button" raised on-click="aaa">Crear paquete</paper-button></div>
                  </div>
                </template>

                <template is="dom-if" if="[[selectedpackage]]">
                  <div class="layout vertical header-add-package">
                  <span>Nombre del paquete</span>
                  <div>
                    <div class="layout horizontal" style="display: inline-flex;">
                      <paper-input label="Receptor"></paper-input>
                      <span class="y-o-span"> y/o </span>
                      <paper-input label="DNI, NIF o NIE del receptor"></paper-input>
                    </div>

                    <div class="layout horizontal add-package-buttons">
                      <paper-icon-button icon="accept"></paper-icon-button>
                      <paper-icon-button icon="close"></paper-icon-button>
                    </div>
                  </div>
                  </div>
                </template>

                <div class="container-add-package">
                  <!-- Meter los package-line aqui -->
                  <package-line></package-line>
                </div>
              </div>
          </td>
        </tr>
        <tr>
          <td colspan="2">Precio final</td>
          <td><span>[[getTotal(d, a, seat, pkn)]]</span>€</td>
          <td><button>Solicitar</button></td>
        </tr>

      </table>
    </div>
	</template>
	<script>
		Polymer({
      is: "trip-request",
      properties: {
      	selectedpackage: {
          type: Boolean,
          value: false
        },
        trip: {
      		type: Object,
      		value: {}
      	},
      	d: {
      		type: Number,
      		value: 0
      		// observer: 'dChanged'
      	},
      	a: {
      		type: Number,
      		value: 0
      		// observer: 'aChanged'
      	},
      	pkn: {
      		type: Number,
      		value: 0
      	},
      	seat: {
      		type: Boolean,
      		value: true
      	},
      	priceUser: Number,
      	pricePackages: Number
      },
      // byIndex: function(index) {
      // 	console.log(this.trip);
    		// if(this.trip && this.trip.wps) {
    		// 	console.log("month: " + this.trip.wps[index].month);
    		// 	return this.trip.wps[index];
    		// }
      // }
      // dChanged: function() {
      	// this.request.d = this.trip.wps[this.d];
      	// rd = this.trip.wps[this.d].day;
      	// console.log("d: " + this.d + ", day:" + this.request.d.day + ", month:" + this.request.d.month);
      // },
      // aChanged: function() {
      	// this.request.a = this.trip.wps[this.a];
      // },
      getd: function(i) {
      	if(this.trip && this.trip.wps) return this.trip.wps[i].day;
      },
      getm: function(i) {
      	if(this.trip && this.trip.wps) return this.trip.wps[i].month;
      },
      gett: function(i) {
      	if(this.trip && this.trip.wps) return this.trip.wps[i].time;
      },
      geta: function(i) {
      	if(this.trip && this.trip.wps) return this.trip.wps[i].address;
      },
      getc: function(d, a, s, unchanged) {
      	var pu = 0;

      	if(s && this.trip && this.trip.wps) {
      		var wps = this.trip.wps;
      		var cost = wps[a].cost - wps[d].cost;
      		
      		if(cost >= 0) pu = cost;
      		// else throw "The cost can't be negative";
      	} 

      	if(!unchanged) this.priceUser = pu;
      	return pu;
      },
      getpkc: function(d, a, pkn, unchanged) {
      	var pp = 0;

      	if(this.trip && this.trip.wps) {
      		var wps = this.trip.wps;
      		var cost =  wps[a].pkcost - wps[d].pkcost;
      		if(cost >= 0) pp = cost * pkn;
      		// else throw "The package cost can't be negative";
      	}

      	if(!unchanged) this.pricePackages = pp;
      	return pp;
      },
      getT: function(d, a, s, pkn) {
      	return this.getc(d, a, s, true) + this.getpkc(d, a, pkn, true);;
      },
      getTotal: function() {
      	return this.priceUser + this.pricePackages;
      }
    });
	</script>
</dom-module>