<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module name="assessment-service">
  <style>
    :host {
      display: none;
    }
  </style>
  
  <template>
    <iron-ajax id="loadAll"
      last-response="{{response}}"
      on-response="assessmentsLoaded">
    </iron-ajax>

    <iron-ajax id="loadOne"
      last-response="{{response}}"
      on-response="assessmentLoaded">
    </iron-ajax>
    
    <iron-ajax id="create"
      body="{{update}}"
      last-response="{{response}}"
      on-response="createdResponse"
      content-type="application/json"
      method="POST">
    </iron-ajax>
    
  </template>
  <script>
    Polymer({
      is: "assessment-service",
      properties: {
        data: {
          type: Object,
          notify: true
        },
        fetch: {
        	type: String
        	// observer: 'fetchChanged'
        },
        response: {
          type: Object,
          notify: true
        },
        user: {
        	type: Number,
        	observer: 'userChanged'
        },
        ready: {
          type: Boolean,
          value: false
        },
        update: String
      },
      
      ready: function() {
        console.log("assessment-service ready! for: " + this.fetch);
        this._ready = true;
      },
      userChanged: function() {
        if(this.fetch == "all") { 
        	if(this.user) {
        	  this.$.loadAll.url = window.Polymer.restAPI + "users/" + this.user + "/assessments";
        	  console.log("Assessments loading for user!: ");
        	} else this.$.loadAll.url = window.Polymer.restAPI + "assessments";

        	console.log("Assessments loading with: " + this.$.loadAll.url);
        	
        	this.$.loadAll.generateRequest();
        }
      },
      
      // fetchChanged: function() {
      //   if(this.fetch == "all") {
      //     console.log("Fetching all assessments");

      //   	if(this.user)
      //   	  this.$.loadAll.url = window.Polymer.restAPI + "users/" + this.user + "/assessments";
      //     else this.$.loadAll.url = window.Polymer.restAPI + "assessments";

      //     console.log("assessments to fetch: " + this.$.loadAll.url);
      //     this.$.loadAll.generateRequest();
      //   }
      //   else if(this.fetch != "") {
      //   	console.log("ESTO ES: " + this.fetch);
      //   	this.$.loadOne.url = window.Polymer.restAPI + "assessments/" + this.fetch;
      //     this.$.loadOne.generateRequest();
      //   }
      // },
      
      assessmentsLoaded: function() {
        // Make a copy of the loaded data
        console.log('Assessments loaded:');
        console.log(this.response);
  //       this.data = this.$.loadAll.response.slice(0);
        // this.data = this.$.loadAll.lastResponse;
        // this.response = this.data;
        this.data = this.response;

        this.fire('loaded');
      },
      
      assessmentLoaded: function() {
        console.log('Assessment Loaded:');
        console.log(this.response);
        // this.data = this.$.loadOne.lastResponse;
        // this.response = this.data;
        this.data = this.response;

        this.fire('loaded');
      },
      
      saveData: function() {
        console.log('SAVING ASSESSMENT');
        this.$.create.url = window.Polymer.restAPI + "assessments";
        this.$.create.generateRequest();
      },
      
      createdResponse: function() {
        // this.response = this.$.create.lastResponse;
      }
    });
  </script>
</dom-module>
