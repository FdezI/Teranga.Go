<link rel="import" href="trip-list.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<link rel="import" href="location-service.html">

<!-- <link rel="import" href="in-array-validator.html"> -->
<link rel="import" href="trip-search-validator.html">

<dom-module name="trip-table">
  <style>
  .selector {
    padding: 10px;
    border: 1px solid #ccc;
    background: #ddd;
    text-align: center;
    margin: 5px;
  }
  .selector input{
    margin: 0;
    padding: 0;
    -webkit-appearance:none;
       -moz-appearance:none;
            appearance:none;
  }

  .selector input:active +.radio-img{opacity: .9;}
  .selector input:checked +.radio-img{
    border: 3px solid #999;
    box-shadow: 2px 2px 10px #999;
  }
  .radio-img {
    padding: 3px;
    border: 1px solid #333;
    cursor:pointer;
    display:inline-block;
  }
  .radio-img:hover{
    -webkit-filter: brightness(1.2);
       -moz-filter: brightness(1.2);
            filter: brightness(1.2);
    box-shadow: 2px 2px 10px #999;
  }
  .img-size {
    width: 40px;
  }
  .options-selector {
    border: 1px solid #ccc;
    background: #ddd;
    text-align: center;
    padding: 5px;
  }
  .search-td {
    text-align: right;
    vertical-align: bottom;
  }
  .search-button {
    width: 96%;
    margin: 2%;
  }
  .trip-table-header {
    background: #ccc;
    border-radius: 30px 30px 0 0;
    padding: 15px;
  }
  .trip-table-content {
    border: 1px solid #ccc;
  }
  </style>
  
  <template>
    <location-service id="ls" fetch="list" data="{{locs}}"></location-service>
    <trip-search-validator items="[[locs]]" attrib="city" difff="[[fakefilters.origin]]" diffs="[[fakefilters.destination]]"></trip-search-validator>
    
    <table>
      <tr>
        <td colspan="2">Encuentra el viaje que necesitas</td>
      </tr>
      <tr>
        <datalist id="locs">
          <template id="asdf" is="dom-repeat" items="[[locs]]">
            <option id="[[index]]" value="[[item.city]]">
          </template>
        </datalist>
        <td>
          <paper-input id="origin" autocomplete="on" type="text" label="De:" placeholder="Origen" list="locs" value="{{fakefilters.origin}}" validator="trip-search-validator" required></paper-input>
        </td>
        <td>
          <paper-input id="destination" type="text" label="A:" placeholder="Destino" list="locs" value="{{fakefilters.destination}}" validator="trip-search-validator" required></paper-input>
        </td>
      </tr>
      <tr>
        <td colspan="2">Cuando lo necesitas</td>
      </tr>
      <tr>
        <td>Desde: <input type="date" placeholder="Desde" value="{{filters.from::input}}" min="[[today()]]"></td>
        <td>Hasta: <input type="date" placeholder="Hasta" value="{{filters.to::input}}" min="[[today()]]"></td>
      </tr>
      <tr>
        <td>
          <div class="selector">
            <input id="pet-allow" type="radio" name="pets" value="allow" />
            <label class="radio-img" for="pet-allow"><img class="img-size" src="../images/pet-allow.png"></label>

            <input id="pet-unknown" type="radio" name="pets" value="unknown" checked />
            <label class="radio-img mastercard"for="pet-unknown"><img class="img-size" src="../images/pet-unknown.png"></label>

            <input id="pet-deny" type="radio" name="pets" value="deny" />
            <label class="radio-img mastercard"for="pet-deny"><img class="img-size" src="../images/pet-deny.png"></label>
          </div>
        </td>
        <td>
            <div class="selector">
              <input id="package-allow" type="radio" name="packages" value="allow" />
              <label class="radio-img" for="package-allow"><img class="img-size" src="../images/package-allow.png"></label>

              <input id="package-unknown" type="radio" name="packages" value="unknown" checked />
              <label class="radio-img mastercard"for="package-unknown"><img class="img-size" src="../images/package-unknown.png"></label>

              <input id="package-deny" type="radio" name="packages" value="deny" />
              <label class="radio-img mastercard"for="package-deny"><img class="img-size" src="../images/package-deny.png"></label>
            </div>
        </td>
      </tr>
      <tr>
        <td class="search-td" colspan="2">
          <paper-button class="search-button" raised on-click="search">Buscar</paper-button>
        </td>
      </tr>
    </table>

    <div class="trip-table-header layout horizontal">
      <div class="layout vertical">
        <div>Viajes de <span>[[departure]]</span> a <span>[[arrival]]</span></div>

        <div class="trip-table-filters">
          <span>Ordenar por:</span>
          <select value="Precio descendente">
            <option>Precio ascendente</option>
            <option>Precio descendente</option>
            <option>Estrellas</option>
            <option>Fecha y hora</option>
          </select>
        </div>
      </div>
    </div>
    <div class="trip-table-content">
      <trip-list>
        <template is="dom-repeat" items="{{trips}}" as="trip">
          <trip-card  username="[[trip.driverName]]" score="3" cities="[[trip.cities]]" departure="[[trip.departure]]" arrival="[[trip.arrival]]" day="[[day(trip)]]" month="[[month(trip)]]" hour="[[time(trip)]]" seats="[[trip.free]]" price="[[trip.cost]]" pets="[[allow(trip.animals)]]" packages="[[allow(trip.packages)]]"></trip-card>
        </template>
      </trip-list>
    </div>
  </template>

  <script>
  Polymer({
    is: "trip-table",
    properties: {
      image: String,
      trips: Array,
      filters: {
        type: Object,
        value: {},
        notify: true
      },
      fakefilters: {
        type: Object,
        value: {},
        readOnly: true
      },
      locs: Array
    },

    observers: ['fromChanged(filters.from)', 'toChanged(filters.to)', 'validate(fakefilters.origin)', 'validate(fakefilters.destination)'],

    ready: function() {
      this.$.ls.reload();
    },
    day: function(trip) {
      return Teranga.day(trip.date);
    },
    month: function(trip) {
     return Teranga.month(trip.date);
    },
    time: function(trip) {
      return Teranga.time(trip.date);
    },
    search: function() {
      var locs = this.locs,
          length = locs.length,
          f = this.filters,
          ff = this.fakefilters;
          
      Object.keys(ff).forEach(function(key) {
        var i = -1;
        delete f[key];
        while(++i < length && !f[key])
          if(locs[i].city == ff[key]) f[key] = locs[i].idlocation;
      });

      this.fire('search');
    },
    allow: function(attrib) {
      return attrib ? "allow" : ((attrib == false || attrib == 0) ? "deny" : "unknown");
    },
    fromChanged: function(from) {
      var to = this.filters.to;
      if(!to || from > to) this.set('filters.to', from);
    },
    toChanged: function(to) {
      var from = this.filters.from;
      if(!from || from > to) this.set('filters.from', to);
    },
    today: function() {
      return new Date().toISOString().substring(0, 10);
    },
    validate: function() {
        this.$.origin.validate();
        this.$.destination.validate();
    }
  });
  </script>
</dom-module>