<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/av-icons.html">
<link rel="import" href="notification-line.html">

<link rel="import" href="popup-behavior.html">

<link rel="import" href="data-service.html">

<dom-module name="notification-popup">
  <style>
    :host {
      top: 64px;
      position: fixed;
      /*right: 0px;*/
    }
    .container {
      color: white;
      background: #121212;
      padding: 0;
      width: 300px;
      min-height: 250px;
      /*z-index: 10;*/
    }
    .notification-title {
      background: #222;
      color: #ddd;
      padding: 10px;
    }
    .notification-mark-as-read {
      float: right;
      color: #ccc;
      font-size: 13px;
    }
    .notification-mark-as-read:hover {
      text-decoration: underline;
      cursor: pointer;
    }
    .notifications-list {
      overflow-y: scroll;
      max-height: 270px;
      min-height: 270px;
      padding: 0;
      list-style: none outside none;
      margin: 0;
    }
  </style>
  <template>
    <data-service id="ns" type="notifications" user="[[iduser]]" fetch="all" filters="[[filters]]" data="{{news}}"></data-service>

    <div class="container">
      <div class="notification-title">
        <span>Notificaciones</span>
        <a class="notification-mark-as-read">Marcar como le√≠das</a>
      </div>
      <ul class="notifications-list">
        <template is="dom-repeat" items="[[notifications]]">
          <notification-line notification="[[item]]"></notification-line>
        </template>
        <!-- <notification-line read></notification-line> -->
        <!-- <notification-line></notification-line> -->
      </ul>
    </div>
  </template>

  <script>
    Polymer({
      is: "notification-popup",
      properties: {
        notifications: {
          type: Array,
          value: []
        },
        news: {
          type: Array,
          observer: 'newsChanged'
        },
        iduser: {
          type: Number,
          observer: 'iduserChanged'
        },
        tasked: Boolean,
        filters: {
          type: Object,
          value: {}
        }
      },
      behaviors: [Teranga.PopupBehavior],

      iduserChanged: function() {
        if(this.iduser) {
          if(!this.tasked) {
            // this.set('tasked', true);
            this.request(this);
            setInterval(this.request, Teranga.notificationInterval, this);
          }
        }
      },

      newsChanged: function() {
        console.log("ASDF");
        if(this.news.length > 0) {
          var self = this;
          this.news.forEach(function(n) { self.push('notifications', n); });
          this.news = [];
        }
      },

      request: function(self) {
        self.$.ns.reload();

        self.set('filters.since', new Date());
      }
    });
  </script>
</dom-module>