<link rel="import" href="trip.html">
<link rel="import" href="../elements/trip-table.html">
<!-- <link rel="import" href="../elements/trip-service.html"> -->
<!-- <link rel="import" href="../elements/route-service.html"> -->
<link rel="import" href="../elements/data-service.html">

<link rel="import" href="../elements/car-container.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<link rel="import" href="../elements/trip-edit-route-validator.html">
<link rel="import" href="../elements/trip-edit-origin-validator.html">
<link rel="import" href="../elements/trip-edit-destination-validator.html">
<link rel="import" href="../elements/filter-selector.html">
<link rel="import" href="../elements/location-line.html">

<link rel="import" href="../elements/pop-up.html">
<link rel="import" href="../elements/generic-container.html">
<link rel="import" href="../elements/car-content.html">

<link rel="import" href="../bower_components/google-map/google-map.html">
<!-- <link rel="import" href="../bower_components/google-map/google-map-directions.html"> -->
<link rel="import" href="../patched_components/google-map-directions.html">
<link rel="import" href="../elements/google-map-address-marker.html">

<dom-module name="create-trip">
  <style>
    .trip-map {
      background: #369;
      width: 30%;
      margin: 10px 2% 10px 0px;
      height: 200px;
      align-self: center;
      display: inline-block;
    }
    .basic-info {
      display: inline-block;
      width: 65%;
      min-width: 200px;
      vertical-align: top;
    }
    .create-trip-input {
      min-width: 160px;
      width: 27%;
      display: inline-block;
      margin-right: 10px;
    }
    .create-trip-input-extra {
      min-width: 50px;
      display: inline-block;
      width: 68%;
      padding: 10px 0 10px 1%;
    }
    .extra-info {

    }
    .column1-3, .column2-3, .column3-3 {
      min-width: 200px;
      height: 170px;
      margin: 2.5%;
      padding: 10px;
      vertical-align: top;
      display: inline-block!important;
      width: 25%;
      background: #ccc;
      border: 1px solid #aaa;
    }
  </style>
  <template>
    <data-service id="rs" type="routes" fetch="list" data="{{routes}}"></data-service>

    <datalist id="routes">
      <template is="dom-repeat" items="[[routes]]">
        <option value="[[item.name]]">
      </template>
    </datalist>

    <datalist id="origins">
      <template is="dom-repeat" items="[[origins]]">
        <option value="[[item.city]]">
      </template>
    </datalist>
    <datalist id="destinations">
      <template is="dom-repeat" items="[[destinations]]">
        <option value="[[item.city]]">
      </template>
    </datalist>
    
    <div>
      <div class="trip-map">
        <google-map map="{{map}}" latitude="27.2785308" longitude="-6.7255617" fit-to-markers></google-map>
        <template is="dom-if" if="[[map]]">
          <google-map-directions map="{{map}}" start-address="[[mapData.origin]]" end-address="[[mapData.destination]]" waypoint-addresses="[[mapData.waypoints]]">
          </google-map-directions>

          <template is="dom-repeat" items="[[origins]]">
            <google-map-address-marker map="{{map}}" address="[[address(item)]]" identifier="[[item.city]]" on-selected="selectMarkOrig"></google-map-address-marker>
          </template>
          <template is="dom-repeat" items="[[destinations]]">
            <google-map-address-marker map="{{map}}" address="[[address(item)]]" identifier="[[item.city]]" on-selected="selectMarkDest"></google-map-address-marker>
          </template>
        </template>
      </div>

      <div class="basic-info">
        <div>
          <data-service id="rs2" type="routes" fetch="[[selectedRoute.idroute]]" data="{{selectedRoute}}" on-response="routeLoaded"></data-service>
          <trip-edit-route-validator items="[[routes]]" attrib="name" ></trip-edit-route-validator>
          <paper-input id="routeInput" label="Ruta" list="routes" value="{{fakefilters.route}}" validator="trip-edit-route-validator" required auto-validate on-input="routeSelected"></paper-input>
        </div>

        <div>
          <trip-edit-origin-validator items="[[origins]]" attrib="city" ></trip-edit-origin-validator>
          <paper-input id="origInput" class="create-trip-input" label="De:" list="origins" placeholder="Salida" value="{{fakefilters.origin}}" validator="trip-edit-origin-validator" required auto-validate></paper-input>
          <input class="create-trip-input-extra" placeholder="Direccion" value="{{filters.address::input}}">
        </div>
        <div>
          <trip-edit-destination-validator items="[[destinations]]" attrib="city" ></trip-edit-destination-validator>
          <paper-input id="destInput" class="create-trip-input"  label="A:" list="destinations" placeholder="Llegada" value="{{fakefilters.destination}}" validator="trip-edit-destination-validator" required auto-validate></paper-input>
          <input class="create-trip-input-extra" placeholder="Direccion" value="">
        </div>

        <div class="layout horizontal">
          <div class="layout vertical">
            <span>Fecha</span>
            <input type="date" min="[[today()]]" required>
          </div>
          <div class="layout vertical">
            <span>Hora</span>
            <input type="time" required>
          </div>
        </div>
      </div>

    </div>

    <div class="extra-info">
      <div class="column1-3 layout vertical">
        <filter-selector type="pet" selected="{{filters.animals}}"></filter-selector>
        <filter-selector type="package" selected="{{filters.packages}}"></filter-selector>
      </div>

      <div class="column2-3 layout vertical">
        <paper-input class="create-trip-input" label="Coche" readonly always-float-label on-keypress="showCarSelect" on-click="showCarSelect" value="[[car.idcar]]"></paper-input>
        <div class="layout vertical">
          <span>Asientos libres</span>
          <paper-slider class="create-trip-input" label="Asientos" always-float-label min="1" max="4" pin snaps editable></paper-slider>
        </div>
      </div>

      <div class="column3-3 layout vertical">
        <span>Precio</span>
        <paper-slider class="price-slider" always-float-label min="1" max="4" pin snaps editable></paper-slider>
        <div class="layout horizontal">
          <span class="flex">Asiento</span>
          <div>x <span>13</span>€</div>
        </div>
        <div class="layout horizontal">
          <span class="flex">Paquete</span>
          <div>x <span>10</span>€</div>
        </div>
      </div>
    </div>

    <div class="vertical-separator"></div>

    <div class="create-trip-other-locations">
      <span>Paradas intermedias</span>
      <location-line name="[[fakefilters.origin]]" stop></location-line>
      <template is="dom-repeat" items="[[others]]">
        <location-line name="[[item.city]]" retardation></location-line>
      </template>
      <location-line name="[[fakefilters.destination]]" stop></location-line>
    </div>




    <div>
      <paper-button raised on-click="saveData">Guardar</paper-button>
      <paper-button raised on-click="discardData">Cancelar</paper-button>
    </div>


    <pop-up id="car_select" with-backdrop>
      <car-content iduser="[[user.iduser]]" data="[[user.cars]]" selected="{{car}}" on-select="hideCarSelect" load></car-content>
    </pop-up>
    <!-- <paper-dialog id="car_select" with-backdrop>
      <car-container iduser="[[user.iduser]]" cars="[[user.cars]]" on-select="selectCar"></car-container>
    </paper-dialog> -->
  </template>

  <script>
    Polymer({
      is: "create-trip",
      properties: {
        user: Object,
        car: Object,
        routes: Array,
        selectedRoute: Object,
        origins: Array,
        destinations: Array,
        others: Array,
        fakefilters: {
          type: Object,
          value: {},
          readOnly: true
        },
        filters: {
          type: Object,
          value: {}
        },
        items: Object,
        mapData: {
          type: Object,
          value: {origin: "Madrid, España", destination: "Dakar, Senegal"}
        }
      },
      observers: ['locSelected("origin", fakefilters.origin)', 'locSelected("destination", fakefilters.destination)'],

      attached: function() {
        console.log("create-trip ready!");
        this.$.rs.reload();
      },
      showCarSelect: function() {
        this.$.car_select.open();
      },
      hideCarSelect: function() {
        this.$.car_select.close();
      },
      // selectCar: function(e, car) {
      //   this.idcar = car.idcar;
      //   this.hideCarSelect();
      // },
      routeSelected: function(e) {
        var routes = this.routes;
        if(!e.target.invalid) {
          var route = this.selectedRoute = routes[Teranga.indexOf(e.target.value, routes, "name")];

          if(!route.wps) this.$.rs2.reload();
        }
        else {
          this.set('origins', []);
          this.set('destinations', []);
          this.set('others', []);
        }

        this.set('fakefilters.origin', "");// = "";
        this.set('fakefilters.destination', "");
        // this.$.origInput.validate();
        // this.$.destInput.validate();
      },
      routeLoaded: function(e, route) {
        // this.origins = [];
        // this.destinations = [];
        // this.others = [];
        var wps = route.wps;

        this.origins = [];
        this.destinations = [];
        this.others = [];

        // this.mapData.waypoints = [];
        this.set('mapData.waypoints', []);
        if(wps && wps.length > 1) {
          var first = wps[0].order,
              last = wps[wps.length - 1].order,
              self = this;

          route.wps.forEach(function(loc) {
            var order = loc.order;
            if(order == first) self.push('origins', loc);
            else if(order == last) self.push('destinations', loc);
            else {
              self.push('mapData.waypoints', {location: self.address(loc), stopover: false});
              self.push('others', loc);
            }
          });
        }


        



        // this.origins = origins;
        // this.destinations = destinations;
        // this.others = others;
      },

      selectMarkOrig: function(e, identifier) {
        this.set('fakefilters.origin', identifier);
      },
      selectMarkDest: function(e, identifier) {
        this.set('fakefilters.destination', identifier);
      },
      locSelected: function(type) {
        console.log("BLUR");
        var rte = this.selectedRoute;
        if(rte) {
          console.log("BLUR 1");
          var wps = rte.wps;
          if(wps) {
            console.log("BLUR 2: type: " + type + ", filter: " + this.fakefilters[type]);
            var index = Teranga.indexOf(this.fakefilters[type], wps, 'city');
            if(index >= 0) {
              var loc = this.selectedRoute.wps[index];

              console.log("LLEGA CON BLUR (" + type + ") = " + loc.city);
              this.set('mapData.' + type, this.address(loc));
            }
          }
        }
      },

      // origSelected: function() {return this.locSelected('origin')},
      // destSelected: function() {return this.locSelected('destination')},

      discardData: function() {
        this.fire('discard');
      },

      today: function() {
        return Teranga.today();
      },

      address: function(wp) {
        return wp.city + "," + wp.country;
      }
    });
  </script>
</dom-module>